=====================================================================
Shine Mosquito, shine !!!!
=====================================================================
 Final project 585
-------------------
Ignacio Alvarez and  Natalia da Silva
========================================================


## Introduction
Iowa State University Medical Entomology Laboratory and Iowa Department of Public Health and the University Hygienic Lab (Iowa City, IA), have been monitored on an anual basis mosquito populations and mosquito-borne disease in the State of Iowa since 1969. "The primary goal of this project was to integrate light trap data from these efforts into a centralized back-end database and interactive website that is available through the internet at http://iowa-mosquito.ent.iastate.edu." (this web page is down from April 7-th).

In the web page from Entomology Laboratory you can find weekly mosquito abundance compared with data from previous years. Additional interactive capabilities facilitate analyses of the data based on mosquito species, distribution, or a time frame of interest. All data can be viewed in graphical and tabular format and can be downloaded.


##Objective
The objective of this project is design a web application using shiny package to help entomologist to visualize, summarize and analyze the data produced by the surveillance program. 
The information presented in the Entomology Laboratory web today allows see information by specie along all the years  but we can never see more than one specie of more than one site at the same time. Then the information is there but the comparison is difficult because the visualization tool is not adequate to make a comparative analysis as they need. 


## Shiny structure


This long-term data set in a centralized database/website is useful for
informing mosquito and mosquito-borne disease control and for exploring the ecology of the species
represented therein.



How to run the shiny direct from GitHub:
* go to https://github.com/nachalca/mosquito_shine
* download the file 'shiny_msq'
* change your directory where is the 'shiny_msq' file
* finally runApp('shiny_msq') in R


```{rpack, echo=FALSE, message=FALSE,warning=FALSE}
library(vegan)
library(ggplot2)
library(reshape2)
library(plyr)
library(gridExtra)
```

```{rdata, echo=FALSE, cache=TRUE, message=FALSE,warning=FALSE}
# load data sets we use
msq<- read.csv('shiny_msq/msqdata.csv', header=T)
msq.res<-msq[,c('site','year','Abundance','SpeciesRichness','DominanceBP', 'Simpson', 'Shannon', 'Evenness', 'AevexansRatio')]
msq.long <- read.csv('shiny_msq/msq_long.csv', header=T)
msq.long$subregion <- msq.long$site
levels(msq.long$subregion) <- c("black hawk", "black hawk", "polk","scott","woodbury","polk","black hawk","scott" )
msq.spyr <- ddply(.data=msq.long,.variables=c('year','specie'),function(x) data.frame(x , prop.spyr=mean(x$prop.spst)) )
msq.ind.aux <- melt(msq[,c(1,2,40:46)],id.vars=c('site', 'year'))
colnames(msq.ind.aux)[3:4] <- c('Index', 'Index.val')

ia.c <- map_data('county', 'iowa')
ia.s <- map_data('state', 'iowa')
ia2 <- subset(ia.c, subregion %in% unique(msq.long$subregion))
#ia2$order <- NULL
#msq.ia <- merge(msq.spyr,ia2, by= 'subregion')

# only for UI
lab.index<-c("Abundance","SpeciesRichness", "DominanceBP","Simpson",  "Shannon"  , "Evenness","AevexansRatio","DegreeDayExact",
"PrecipationExact" ,"DegreeDayMinus2","PrecipationMinus2")
cap1 <-'Yearly species proportion per site. The red line represents the mean proportion for each species across sites'
cap4 <-'The right panel show the density of the distantce to the mean community, the red line es the quatile.
        In left panel each point is a site-year and the red ones are the extreme communities.'


#density plot for rare communities id
msq.sp <- colnames(msq)[-c(1:2, 39:52)]
env   <- colnames(msq)[c(39:52)]
# Compute species proportion on each site*year and the mid-community
prop <- (msq[,msq.sp]) /apply(msq[,msq.sp],1,sum, na.rm=T)
mid.comu <- apply(prop, 2, mean)
dist.out <- as.matrix(vegdist( rbind(prop,mid.comu),dist='euclidean') ,nrow=161) 
msq$distout <- dist.out[-161,161]
dat.den<-density(c(-msq$distout,msq$distout),from=0)
```

At this point we have written a shiny app based on part of the entire data set, we are using yearly mosquito counts for  8 sites and 20 years of data. However complete data has more sites and years on weakly basis. The shiny app have 4 tabset panels each of them with a different plot, we describe each tabset with an example. 

--------------------------------------------
- 1) Tabset 1: Individual species description
--------------------------------------------
In the first tabset we present a figure for individual species. In this figure we can select only 1 species at time, and additionally select multiple sites. The information presented in this plot is yearly species proportion  facet per site. In the each plot there are a reference line that represents the mean proportion for each species across sites. 

Choices on shiny: Species (only one) and Sites. 

```{rtab1, dependson=c('data')}
d <- subset(msq.spyr, (specie == 'Aedes.vexans') & (site == 'Gvalley') )
ggplot(data=d, aes(x=year,y=prop.spst),color=site)+geom_point(size=4)+geom_line()+geom_line(aes(x=year,y=prop.spyr), color=I('red')) +facet_wrap(facets=~site, scales='free')
```

As an example, we show here the proportion of Aedes.Vexan on Green Valley over time, the red line represent the average proportion of this species on each year. So on average across all years and sites, this species represent around 75% of the mosquito counts. However on Green Valley the Aedes.Vexan proportion is most of the time below the mean, What happen in Green Valley ? The Vexans don't like it anymore !!!! 

--------------------------------------------
- 2) Second tabset: Spatial comparison 
--------------------------------------------

Our second tabset has a map, here we can select multiple species and multiple sites, the idea is to find species that share habitats and other species which are likely to be in different places. 

```{rtab2}
d <- subset(msq.spyr, specie %in% c('Aedes.triseriatus','Culex.pipiens.group'))
d1 <- ddply(d, .(specie,subregion),summarise, 
            prop.diff = mean((prop.spst-prop.spyr)/prop.spyr) ,
            prop.st = mean(prop.spst), prop.yr = mean(prop.spyr),
            lgst = prop.st/(1-prop.st) , lgyr = prop.yr/(1-prop.yr),
            or = log(lgst/lgyr), rr = prop.st/prop.yr
            )
msq.ia <- merge(d1,ia2, by= 'subregion')

p <- ggplot() + geom_polygon(data=ia.s, aes(x=long,y=lat,group=region, order=order) ) +
theme(axis.text=element_blank(), axis.title=element_blank(),
                       axis.line=element_blank(),
                       axis.ticks=element_blank(),
                       panel.border=element_blank(),
                       panel.grid=element_blank())
 
p + geom_point(data=msq.ia, aes(x=long, y=lat, group=group) ) + facet_wrap(~specie) 
```

--------------------------------------------
- 3) Third tabset: Community description
--------------------------------------------
One important feature for the entomologist is to study the community characteristics, they are several indices reflecting different aspects of the mosquito community composition. In this plot we can choose multiple indices and multiple sites to plot the yearly value of each index on each site. These are community level plots.

```{rtab3}
d <- subset( msq.ind.aux, (site %in% c("Gvalley","Union")  ) & (Index%in% c('Simpson', 'SpeciesRichness') ))
 ggplot(data=d, aes(x=year,y= Index.val))+geom_point(size=4)+
             geom_line()+geom_line(aes(x=year,y=Index.val), color=I('red'))+facet_grid(facets=Index~site, scales='free')
```

We have choose Green Valley and Union stations with Species Richness and Simpson Index. Both measures are related to the diversity in the community. 

--------------------------------------------
- 4) Fourth tabset: Identify extreme communities
--------------------------------------------
Besides describing each community we may be interesting in comparing them, in particular we want to know if all communities are alike or there are some site-year observations that are different from the rest. 

Working with species proportion within one site and year (instead of total counts) we compute an "average community" which simply taking average of each species proportion. 
Then for each observations we compute the distance respect to that average community. 

We plot a two panel figure, on the right is the estimated density of the distances to the mid point community. The vertical red line represent the 90 quantile. 

On the left panel there is a scatter plot of two community variables and we colored the points corresponding to communities further from the center community, this is with distance bigger than its 90% quantile. 

```{rtab4}
q <- quantile(msq$distout, probs=.9) 
d <- data.frame(lax = msq[,'PrecipationMinus2'], lay=msq[,'DominanceBP'],rare=as.factor( msq$distout > q)) 

p1 <- qplot(x=dat.den$x, y=dat.den$y,geom='line',size=I(1.5)) + geom_vline(xintercept=q,color=I('red')) +
          ylab('') + xlab('Distance to Average Community')

p2 <- qplot(data=d, lax,lay, color=rare)  + scale_color_manual(values=c('black', 'red')) +
            xlab(as.character('PrecipationMinus2')) + ylab(as.character('DominanceBP')) + theme(legend.position='bottom')
grid.arrange( p1, p2 ,ncol=2 )                                                                                         
```

On the shiny it is possible to choose the quantile that determine which communities are consider extreme and also the variables plot in the right panel. In this example the selected quantile is 90% and the variables are Precipitation (horizontal) and Dominance index (vertical). Basically we can see all extreme communities shows big values in Dominance but are not extreme on precipitation. 

- Next Steps
------------

We have just got the complete data set, with more than 30 sites over 15 Iowa counties (instead of 8 sites on 4 counties), and data back to 70's (not all years for every site). So probably next week will be the data processing steps (cleaning and summarizing) with no much advance on shiny. 

On the application aspects, we may include more tools to measure distances among communities, as an MDS analysis of community distance matrix using {\tt vegan} package.

